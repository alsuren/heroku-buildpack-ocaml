#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2

export OPAMROOT=$CACHE_DIR/.opam

echo "-----> Install OPAM and OCaml"
if [ -f $CACHE_DIR/opam ]; then
	echo ">> From cache: $CACHE_DIR"
	cp -a $CACHE_DIR/opam /app/vendor
else
	echo ">> From scratch"
	curl https://raw.githubusercontent.com/ocaml/opam/master/shell/opam_installer.sh -o opam_installer.sh
	mkdir -p /app/vendor
	yes N | sh opam_installer.sh /app/vendor || true
	cp -a /app/vendor/opam $CACHE_DIR/
fi

eval `/app/vendor/opam config env`
cd $BUILD_DIR

/app/vendor/opam install -y `cat .opam-pkgs`
make
